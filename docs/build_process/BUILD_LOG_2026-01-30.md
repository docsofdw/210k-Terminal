# Build Log - January 30, 2026

## Summary

Completed the Market Data API Migration and fixed critical diluted mNAV calculation issues.

## Work Completed

### 1. Market Data API Migration (Completion)

**Files Created/Modified:**
- `lib/api/marketdata.ts` - MarketData.app client for US stocks
- `lib/api/twelve-data.ts` - Twelve Data client for balance sheet fundamentals
- `lib/services/market-data-service.ts` - Unified market data service with provider routing
- `lib/services/calculation-service.ts` - Centralized metric calculations
- `app/api/cron/sync-market-data/route.ts` - New cron for stock price updates (every 15 min)
- `app/api/cron/sync-fundamentals/route.ts` - New cron for balance sheet data (daily)
- `vercel.json` - Added new cron schedules

**Provider Routing Strategy:**
```
US Stocks (no suffix) → MarketData.app
International (.T, .HK, .L, .V, etc.) → Yahoo Finance
Balance Sheet Data → Twelve Data
```

**Why Yahoo Finance for International:**
Twelve Data doesn't support Yahoo-style ticker suffixes (.T for Tokyo, .HK for Hong Kong, etc.). Attempted to use Twelve Data's exchange parameter but it didn't work reliably. Yahoo Finance provides reliable coverage for all international exchanges.

### 2. Diluted mNAV Fix (Critical)

**Problem Discovered:**
The Value Screener was showing incorrect mNAV values. Example:
- XXI in Comps table: 1.50x (D.mNAV)
- XXI in Value Screener: 0.02x (Basic mNAV)

**Root Cause:**
The `daily-snapshot` cron was calculating mNAV using basic shares instead of diluted shares. For companies with significant dilution (XXI: 10.3M basic → 709.9M diluted), this caused massive discrepancies.

**Fix Applied:**
Updated `app/api/cron/daily-snapshot/route.ts` to:
1. Use `dilutedMarketCapUsd` from companies table
2. Use `dilutedEvUsd` from companies table
3. Use `dilutedMNav` from companies table
4. Fall back to calculated values if not available

**Files Modified:**
- `app/api/cron/daily-snapshot/route.ts` - Use diluted values

### 3. Historical Data Backfill

**Problem:**
289+ days of historical snapshots had incorrect basic mNAV values.

**Solution:**
Created and ran a backfill script that:
1. Calculated dilution ratio for each company (diluted shares / basic shares)
2. Applied ratio to historical mNAV values where appropriate
3. Capped extreme values to prevent outliers

**Results:**
```
Updated: 520 snapshots
Skipped: 754 snapshots (already correct or no dilution)
```

**Verification:**
- XXI 2026-01-29: 1.5370x (was 0.0223x)
- XXI 2026-01-30: 1.5100x

### 4. UI Label Updates

Updated all UI components to consistently use "D.mNAV" (Diluted mNAV) labeling:

**Files Modified:**
- `app/(authenticated)/dashboard/charts/_components/screener/relative-value-screener.tsx`
  - Column header: "mNAV" → "D.mNAV"
  - Added tooltip: "Diluted mNAV - Enterprise Value ÷ BTC NAV (using fully diluted shares)"

- `app/(authenticated)/dashboard/charts/_components/company-mnav-chart.tsx`
  - Tooltip: "mNAV" → "D.mNAV"
  - Line name: "mNAV" → "D.mNAV"

- `app/(authenticated)/dashboard/charts/_components/mnav-chart.tsx`
  - Legend: "Avg mNAV" → "Avg D.mNAV"
  - Legend: "Median mNAV" → "Median D.mNAV"
  - Legend: "Weighted Avg mNAV" → "Wtd Avg D.mNAV"

### 5. Documentation Updates

**Files Updated:**
- `docs/CALCULATIONS.md` - Added Diluted mNAV section with formulas and examples
- `docs/API_INTEGRATIONS.md` - Added MarketData.app, updated provider routing, updated cron schedule
- `docs/build_process/MARKET_DATA_API_MIGRATION.md` - Marked as complete with summary

## Environment Variables Added

```bash
MARKETDATA_API_KEY=xxx  # Added to Vercel
TWELVE_DATA_API_KEY=xxx # Added to Vercel
```

## Technical Decisions

### Why Three Providers Instead of Two

Original plan: MarketData.app (US) + Twelve Data (international + fundamentals)

Actual implementation: MarketData.app (US) + Yahoo Finance (international) + Twelve Data (fundamentals only)

**Reason:** Twelve Data requires exchange-specific symbol formats that don't match our database (e.g., "TSE:3350" vs "3350.T"). Yahoo Finance handles all international exchanges reliably with our existing ticker format.

### Diluted vs Basic mNAV

The system now consistently uses **Diluted mNAV** throughout:
- Comps table: D.mNAV column
- Value Screener: D.mNAV column
- Daily snapshots: Store diluted mNAV
- Charts: Show diluted mNAV

Basic mNAV is still calculated and stored but not displayed in primary views.

## Files Changed Summary

```
New Files:
  app/api/cron/sync-market-data/route.ts
  app/api/cron/sync-fundamentals/route.ts
  lib/api/marketdata.ts
  lib/api/twelve-data.ts
  lib/services/market-data-service.ts
  lib/services/calculation-service.ts

Modified Files:
  app/api/cron/daily-snapshot/route.ts
  app/(authenticated)/dashboard/charts/_components/screener/relative-value-screener.tsx
  app/(authenticated)/dashboard/charts/_components/company-mnav-chart.tsx
  app/(authenticated)/dashboard/charts/_components/mnav-chart.tsx
  db/schema/companies.ts
  vercel.json
  docs/CALCULATIONS.md
  docs/API_INTEGRATIONS.md
  docs/build_process/MARKET_DATA_API_MIGRATION.md
```

## Verification

After all changes:
- `npm run types` - Passes
- `npm run lint` - Passes (only pre-existing warnings)
- XXI mNAV in Value Screener: 1.51x (matches Comps table)
- Historical data: Backfilled correctly

## Next Steps

1. Commit and deploy changes
2. Monitor sync-market-data cron performance
3. Monitor API rate limits and costs
4. Consider removing legacy Google Sheets sync code
